name: Simple CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Test
      run: go test ./...

    - name: Create .env file
      run: echo "${{ secrets.ENV_FILE }}" > .env

    - name: Build
      run: go build -o fixdrive cmd/main.go

    - name: Build Docker image
      run: docker build -t fixdrive:latest .

    - name: Deploy to server
      run: |
        echo "üöÄ Deploying to server..."
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 31.97.76.106 >> ~/.ssh/known_hosts
        
        # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
        scp fixdrive root@31.97.76.106:/app/
        scp .env root@31.97.76.106:/app/
        scp docker-compose.yaml root@31.97.76.106:/app/
        scp Dockerfile root@31.97.76.106:/app/
        scp -r migrations root@31.97.76.106:/app/
        
        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh root@31.97.76.106 << 'EOF'
          cd /app
          docker-compose down || true
          docker-compose up -d --build
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ë–î
          sleep 10
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
          source .env
          docker run --rm -v $(pwd)/migrations:/migrations --network host migrate/migrate:v4.18.1 \
            -path=/migrations -database="postgres://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME?sslmode=disable" up
          
          echo "‚úÖ Migrations applied"
          echo "‚úÖ Service restarted"
        EOF
        
        echo "‚úÖ Deployed successfully" 